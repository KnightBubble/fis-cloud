var express = require('express'),
    http = require('http'),
    cluster = require('cluster'),
    app = express();

    app.set('port', process.env.PORT || 8337);
    app.use(express.logger('dev'));
    app.use(express.bodyParser());
    app.use(express.methodOverride());
    app.use(express.errorHandler());
    app.use(app.router);

    app.get(/^\/([^\/]+?)\/(([^\/]+?$)|([^\/]+?)(?:\/)(.*))$/, function(req, res){
        var app = fis.require(req.params[0]);
        var method = req.params[2] || req.params[3];

        if(typeof app[method] === 'function'){
            app[method](req, res);
        }else if(typeof app === 'function'){
            app(req, res);
        } else {
            res.send(404, 'Sorry, Not Found');
        }
    });


    http.createServer(app).listen(app.get('port'), function(){
        console.log('fis server listening on port ' + app.get('port'));
    });

    var fis = module.exports = {};

    fis.require = function(appname){
        var apppath = 'fis-cloud-app-' + appname;
        var path = require.resolve(apppath);console.log(path);
        try{
            return require(path);
        } catch (e){
            e.message = 'unable to load app plugin [' + appname + '], message : ' + e.message;
            console.log(e);
        }
    }

    fis.util = require('./lib/util.js');




