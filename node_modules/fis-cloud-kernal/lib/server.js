'use strict';

var childs = [],
    usedWorkers = [],
    WORKER_NUMBER = 20,
    last_child_pos = 0,
    cp = require("child_process"),
    TCP = process.binding("tcp_wrap").TCP;


function createWorker(){
    //todo 此处需要修改不能使用相对路径
    var worker = cp.fork("./lib/worker.js");
    worker.on("exit", handleWorkerClose);
    return worker;
}

function handleWorkerClose(){
    fis.log.debug("handle worker close");
    for(var i=usedWorkers.length; i>0; i--){
        var worker = createWorker();
        childs[usedWorkers.pop()] = worker;
    }
}

function onconnection(handle){
    fis.log.debug("get a connection");
    last_child_pos++;
    if(last_child_pos >= WORKER_NUMBER){
        last_child_pos = 0;
    }
    fis.log.debug("child " + last_child_pos + " process the connection.");
    childs[last_child_pos].send({"handle" : true}, handle);
    usedWorkers.push(last_child_pos);
    handle.close();
}

function startServer(port){

    var address = "0.0.0.0",
        port = port || 3459,
        server = new TCP();

    //fis.log.debug("starting a server");

    //todo 需要检测端口是否已经开启，提醒报错
    server.bind(address, port);
    server.onconnection = onconnection;
    server.listen(1023);
}

function startWorker(){
    for(var i=0; i<WORKER_NUMBER; i++){
        var worker = createWorker();
        childs.push(worker);
    }
}

console.log(fis);

function start(port){
    startWorker();
    startServer(port);
}

exports.start = start;
