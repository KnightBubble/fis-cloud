'use strict';

var net = require("net"),
    http = require("http"),
    express = require("express"),
    mime = require('mime'),
    fs = require('fs'),
    domain = require("domain"),
    fis = require(__dirname + '/../fis-cloud-kernal.js'),
    app = express(),
    accessLogfile = fs.createWriteStream('access.log', {flags : 'a'}),
    errorLogfile = fs.createWriteStream('error.log', {flags : 'a'});

app.use(express.logger({stream: accessLogfile}));

app.use(function(req, res, next){
    var d = domain.create();
    //监听domain的错误事件
    d.on('error', function(er) {

        //记录log日志
        var errorMsg = '[' + new Date() + '] ' + req.url + '\n' + er.message + '\n' + er.stack + '\n';
        errorLogfile.write(errorMsg);

        //页面返回错误信息
        res.statusCode = 500;
        res.setHeader('content-type', 'text/plain');
        var errorMsg = 'Oops, there was a problem!\nError Message is ' + er.message;
        res.end(errorMsg);
        process.disconnect();
        process.exit();
    });
    d.add(req);
    d.add(res);
    d.run(next);
});

app.all("*", handleRequest);

//express会首先捕获异常，导致domain无法捕获，所以这里使用nextTick跳出express的stack
function handleRequest(req, res){
    process.nextTick(function(){
        var pathName = req.url;
        //todo favicon能否有更好的处理方式？
        if(pathName == "/favicon.ico"){
            var filePath = __dirname + "/../static/favicon.ico",
                contentType = mime.lookup(filePath),
                content = fs.readFileSync(filePath);
            res.type(contentType);
            res.send(content);
        }else{
            if(pathName.substr(0, 1) === '/'){
                pathName = pathName.substr(1);
            }
            var urlSplit =  pathName.split('/');
            var app = requireApp(urlSplit[0]);
            var method = urlSplit[1];
            if(typeof app[method] === 'function'){
                app[method](req, res);
            }else if(typeof app === 'function'){
                app(req, res);
            } else {
                res.send(404, 'Sorry, Not Found');
            }
        }
        process.disconnect();
        process.exit();
    });
}

var server = http.createServer(app);

function handleMessage(self, handle){
    //测试这里是否可以通过设置server的最大连接数为1，完成功能？
    var socket = new net.Socket({
        handle : handle,
        allowHalfOpen : self.allowHalfOpen
    });
    socket.readable = socket.writable = true;
    socket.resume();
    socket.server = self;
    self.emit("connection", socket);
    socket.emit("connect");
}

function requireApp(appName){
    var name = 'fis-cloud-app-' + appName;
    try{
        return require(name);
    }catch(ex){
        ex.message = 'unable to load plugin [' + name + '], message : ' + ex.message;
        fis.log.error(ex);
    }
}

process.on("message", function(m ,handle){
    if(handle){
        handleMessage(server, handle);
    }
});